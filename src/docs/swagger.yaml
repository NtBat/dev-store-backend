openapi: 3.0.0
info:
  title: DevStore API
  version: 1.0.0
  description: API documentation for DevStore backend
  contact:
    name: DevStore Team

servers:
  - url: http://localhost:3333
    description: Development server
  - url: http://localhost:4000
    description: Alternative development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Banners
    description: Banner management
  - name: Products
    description: Product management and catalog
  - name: Categories
    description: Category management and metadata
  - name: Cart
    description: Shopping cart operations
  - name: Users
    description: User authentication and management

paths:
  /ping:
    get:
      summary: Health check endpoint
      description: Returns a pong response to verify the API is running
      tags:
        - Health
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  pong:
                    type: boolean
                    example: true

  /banners:
    get:
      summary: Get all banners
      description: Retrieves all active banners with absolute image URLs
      tags:
        - Banners
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BannersResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /products:
    get:
      summary: Get all products
      description: Retrieves products with filtering, sorting, and limit options. Supports filtering by metadata (e.g., technology tags) using pipe-separated values.
      tags:
        - Products
      parameters:
        - in: query
          name: metadata
          schema:
            type: string
          description: |
            JSON string with metadata filters. Format: `{"categoryMetadataId": "value1|value2|value3"}`.
            Example: `{"tech": "react|node"}` filters products with React OR Node tags.
          example: '{"tech":"react|node"}'
        - in: query
          name: orderBy
          schema:
            type: string
            enum:
              - views
              - selling
              - price
          description: |
            Sort products by:
            - `views` - Most viewed (default)
            - `selling` - Best selling
            - `price` - Lowest price first
          example: views
        - in: query
          name: limit
          schema:
            type: string
            pattern: '^\d+$'
          description: Maximum number of products to return
          example: '10'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /products/{id}:
    get:
      summary: Get product by ID
      description: Retrieves detailed information about a specific product including all images, description, and category. Also increments the product view count.
      tags:
        - Products
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            pattern: '^\d+$'
          description: Product unique identifier
          example: '1'
      responses:
        '200':
          description: Successful response with product details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductDetailResponse'
        '400':
          description: Invalid product ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Product not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Product not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /products/{id}/related:
    get:
      summary: Get related products
      description: Retrieves products from the same category as the specified product, excluding the product itself. Results are ordered by view count (most viewed first). Default limit is 4 products.
      tags:
        - Products
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            pattern: '^\d+$'
          description: Product unique identifier to find related products
          example: '1'
        - in: query
          name: limit
          schema:
            type: string
            pattern: '^\d+$'
          description: Maximum number of related products to return (default is 4)
          example: '4'
      responses:
        '200':
          description: Successful response with related products
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductsResponse'
        '400':
          description: Invalid product ID or limit parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Product not found or no related products available
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Products not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /category/{slug}/metadata:
    get:
      summary: Get category with metadata
      description: Retrieves a category by its slug along with all associated metadata (filters) and their possible values. Useful for building dynamic filter interfaces.
      tags:
        - Categories
      parameters:
        - in: path
          name: slug
          required: true
          schema:
            type: string
          description: Category URL slug
          example: 'camisas'
      responses:
        '200':
          description: Successful response with category and metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryMetadataResponse'
        '400':
          description: Invalid slug parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Category not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Category not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /cart/mount:
    post:
      summary: Mount shopping cart
      description: Retrieves product details for a list of product IDs. Used to mount/validate a shopping cart with current product information (price, availability, etc.). Does not persist cart data in the database.
      tags:
        - Cart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
              properties:
                ids:
                  type: array
                  items:
                    type: string
                    pattern: '^\d+$'
                  description: Array of product IDs (as strings)
                  example: ["1", "2", "3"]
                  minItems: 0
      responses:
        '200':
          description: Successful response with cart products
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartResponse'
        '400':
          description: Invalid request body (missing ids or invalid format)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid request body
        '404':
          description: Cart not found (unlikely, but possible in edge cases)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Cart not found
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /cart/shipping:
    get:
      summary: Calculate shipping cost
      description: Calculates shipping cost and estimated delivery time based on zipcode. Currently returns mock data (cost=10, days=3) - shipping logic to be implemented.
      tags:
        - Cart
      parameters:
        - in: query
          name: zipcode
          required: true
          schema:
            type: string
            minLength: 8
            maxLength: 8
          description: Brazilian zipcode (CEP) with 8 digits (no formatting)
          example: '01310100'
      responses:
        '200':
          description: Successful response with shipping information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShippingResponse'
        '400':
          description: Invalid zipcode format (must be 8 digits)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid query parameters
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /cart/finish:
    post:
      summary: Finish cart and create order
      description: |
        Finalizes the shopping cart by creating an order and generating a Stripe payment link. 
        Requires authentication. This endpoint:
        1. Validates the cart items and address
        2. Creates an order in the database with shipping information
        3. Generates a Stripe Checkout session
        4. Returns the payment URL
      tags:
        - Cart
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - cart
                - addressId
              properties:
                cart:
                  type: array
                  items:
                    type: object
                    required:
                      - productId
                      - quantity
                    properties:
                      productId:
                        type: integer
                        minimum: 1
                        description: Product unique identifier
                        example: 1
                      quantity:
                        type: integer
                        minimum: 1
                        description: Quantity of this product
                        example: 2
                  minItems: 1
                  description: Array of cart items with product IDs and quantities
                  example:
                    - productId: 1
                      quantity: 2
                    - productId: 3
                      quantity: 1
                addressId:
                  type: integer
                  minimum: 1
                  description: User address ID for shipping (must belong to authenticated user)
                  example: 1
      responses:
        '201':
          description: Order created successfully, payment link returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinishCartResponse'
        '400':
          description: Invalid request body (missing or invalid cart/addressId)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid request body
        '401':
          description: Unauthorized - Invalid or missing token
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Unauthorized
        '404':
          description: Address not found or doesn't belong to user
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Address not found
        '500':
          description: Failed to create order or payment link
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Failed to create order

  /user/register:
    post:
      summary: Register new user
      description: Creates a new user account with name, email, and password. Email must be unique. Password is hashed with bcrypt before storage.
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
              properties:
                name:
                  type: string
                  minLength: 3
                  description: User's full name (minimum 3 characters)
                  example: Jo達o Silva
                email:
                  type: string
                  format: email
                  minLength: 10
                  description: User's email address (must be valid and unique)
                  example: joao.silva@example.com
                password:
                  type: string
                  minLength: 8
                  format: password
                  description: User's password (minimum 8 characters, will be hashed)
                  example: senha123456
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid request body or user already exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: User already exists
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/login:
    post:
      summary: User login
      description: Authenticates a user with email and password. Returns a UUID token that is stored in the database and can be used for authenticated requests.
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  minLength: 6
                  description: User's registered email address
                  example: joao.silva@example.com
                password:
                  type: string
                  minLength: 8
                  format: password
                  description: User's password (minimum 8 characters)
                  example: senha123456
      responses:
        '200':
          description: Login successful, token returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid request body
        '401':
          description: Invalid credentials (email or password incorrect)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid email or password
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/addresses:
    post:
      summary: Add user address
      description: Creates a new address for the authenticated user. Requires authentication token in the Authorization header.
      tags:
        - Users
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - zipcode
                - street
                - number
                - city
                - state
                - country
              properties:
                zipcode:
                  type: string
                  minLength: 8
                  description: Address zipcode/postal code (minimum 8 characters)
                  example: '01310100'
                street:
                  type: string
                  minLength: 3
                  description: Street name (minimum 3 characters)
                  example: Av. Paulista
                number:
                  type: string
                  minLength: 1
                  description: Street number
                  example: '1000'
                city:
                  type: string
                  minLength: 3
                  description: City name (minimum 3 characters)
                  example: S達o Paulo
                state:
                  type: string
                  minLength: 2
                  description: State/Province (minimum 2 characters)
                  example: SP
                country:
                  type: string
                  minLength: 2
                  description: Country (minimum 2 characters)
                  example: BR
                complement:
                  type: string
                  description: Additional address information (optional)
                  example: Apto 101
      responses:
        '201':
          description: Address created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddressResponse'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid request body
        '401':
          description: Unauthorized - Invalid or missing token
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Unauthorized
        '500':
          description: Internal server error or failed to create address
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Failed to create user address
    get:
      summary: Get user addresses
      description: Retrieves all addresses for the authenticated user, ordered by creation date (newest first). Requires authentication token in the Authorization header.
      tags:
        - Users
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Addresses retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddressesListResponse'
        '401':
          description: Unauthorized - Invalid or missing token
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Unauthorized
        '500':
          description: Internal server error or failed to get addresses
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Failed to get user addresses

components:
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message

    Banner:
      type: object
      properties:
        img:
          type: string
          description: Banner image URL
          example: http://localhost:3333/media/banners/banner-1.png
        link:
          type: string
          description: Banner redirect link
          example: /products/category

    BannersResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        banners:
          type: array
          items:
            $ref: '#/components/schemas/Banner'

    Product:
      type: object
      properties:
        id:
          type: integer
          description: Product unique identifier
          example: 1
        label:
          type: string
          description: Product name/label
          example: Camisa React
        price:
          type: number
          format: float
          description: Product price
          example: 94.5
        image:
          type: string
          nullable: true
          description: Product image URL (first image)
          example: http://localhost:3333/media/products/camiseta-react-azul.png
        liked:
          type: boolean
          description: Whether the product is liked by the user (TODO - always false for now)
          example: false

    ProductsResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        products:
          type: array
          items:
            $ref: '#/components/schemas/Product'

    ProductDetail:
      type: object
      properties:
        id:
          type: integer
          description: Product unique identifier
          example: 1
        label:
          type: string
          description: Product name/label
          example: Camisa React
        price:
          type: number
          format: float
          description: Product price
          example: 94.5
        description:
          type: string
          nullable: true
          description: Detailed product description
          example: Camisa com logo do React, ideal para front-end developers
        categoryId:
          type: integer
          description: Category ID reference
          example: 1
        images:
          type: array
          items:
            type: string
          description: Array of product image URLs
          example:
            - http://localhost:3333/media/products/camiseta-react-azul.png
            - http://localhost:3333/media/products/camiseta-react-preta.png

    Category:
      type: object
      properties:
        id:
          type: integer
          description: Category unique identifier
          example: 1
        name:
          type: string
          description: Category name
          example: Camisas
        slug:
          type: string
          description: Category URL slug
          example: camisas

    ProductDetailResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        product:
          $ref: '#/components/schemas/ProductDetail'
        category:
          $ref: '#/components/schemas/Category'

    MetadataValue:
      type: object
      properties:
        id:
          type: string
          description: Metadata value unique identifier
          example: react
        label:
          type: string
          description: Human-readable label
          example: React

    CategoryMetadata:
      type: object
      properties:
        id:
          type: string
          description: Category metadata unique identifier
          example: tech
        name:
          type: string
          description: Metadata field name
          example: Tecnologia
        values:
          type: array
          items:
            $ref: '#/components/schemas/MetadataValue'
          description: Available values for this metadata field

    CategoryMetadataResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        category:
          $ref: '#/components/schemas/Category'
        metadata:
          type: array
          items:
            $ref: '#/components/schemas/CategoryMetadata'
          description: Array of metadata fields with their possible values

    CartProduct:
      type: object
      properties:
        id:
          type: integer
          description: Product unique identifier
          example: 1
        label:
          type: string
          description: Product name/label
          example: Camisa React
        price:
          type: number
          format: float
          description: Current product price
          example: 94.5
        image:
          type: string
          nullable: true
          description: Product image URL (first image)
          example: http://localhost:3333/media/products/camiseta-react-azul.png

    CartResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        cart:
          type: array
          items:
            $ref: '#/components/schemas/CartProduct'
          description: Array of products in the cart with current information

    ShippingResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        zipcode:
          type: string
          description: The zipcode used for calculation
          example: '01310100'
        cost:
          type: number
          format: float
          description: Shipping cost in currency
          example: 10
        days:
          type: integer
          description: Estimated delivery time in days
          example: 3

    User:
      type: object
      properties:
        id:
          type: integer
          description: User unique identifier
          example: 1
        name:
          type: string
          description: User's full name
          example: Jo達o Silva
        email:
          type: string
          format: email
          description: User's email address
          example: joao.silva@example.com

    UserResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        user:
          $ref: '#/components/schemas/User'

    LoginResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        token:
          type: string
          format: uuid
          description: Authentication token (UUID v4) stored in database
          example: 550e8400-e29b-41d4-a716-446655440000

    Address:
      type: object
      properties:
        id:
          type: integer
          description: Address unique identifier
          example: 1
        userId:
          type: integer
          description: User ID owner of this address
          example: 1
        zipcode:
          type: string
          description: Address zipcode/postal code
          example: '01310100'
        street:
          type: string
          description: Street name
          example: Av. Paulista
        number:
          type: string
          description: Street number
          example: '1000'
        city:
          type: string
          description: City name
          example: S達o Paulo
        state:
          type: string
          description: State/Province
          example: SP
        country:
          type: string
          description: Country
          example: BR
        complement:
          type: string
          nullable: true
          description: Additional address information
          example: Apto 101
        createdAt:
          type: string
          format: date-time
          description: Address creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Address last update timestamp

    AddressResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        address:
          $ref: '#/components/schemas/Address'

    AddressesListResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        addresses:
          type: array
          items:
            $ref: '#/components/schemas/Address'
          description: List of user addresses ordered by creation date (newest first)

    FinishCartResponse:
      type: object
      properties:
        error:
          type: string
          nullable: true
          description: Error message (null if success)
        url:
          type: string
          format: uri
          description: Stripe Checkout session URL for payment
          example: https://checkout.stripe.com/pay/cs_test_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: UUID
      description: Authentication token obtained from /user/login endpoint
